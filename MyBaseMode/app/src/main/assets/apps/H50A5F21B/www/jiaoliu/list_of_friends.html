<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/style.css" />
		<link href="../css/mui.indexedlist.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/iconfont.css" />
		<style>
			html,
			body {
				height: 100%;
				overflow: hidden;
			}
			.mui-group-list-bar {
			    width: 23px;
			    background-color: rgba(255,255,255,0.2);
			    position: absolute;
			    height: 100%;
			    z-index: 10;
			    right: 0px;
			    -webkit-transition: .2s;
			}
			.mui-group-list-bar a {
			    display: block;
			    text-align: center;
			    font-size: 10px;
			    padding: 0px;
			    margin: 0px;
			    line-height: 12px !important;
			    color: #000;
			}
			.mui-table-view-cell {
			    position: relative;
			    overflow: hidden;
			    padding: 9px 15px;
			    -webkit-touch-callout: none;
			    height: 50px;
			}
			
			.list_of_friends_d1{
				background: #FD9A44;
				width: 32px;
				height: 32px;
				border-radius:3px;
				text-align: center;
				line-height: 32px;
			}
			.list_of_friends_d2{
				background: #07BC05;
				width: 32px;
				height: 32px;
				border-radius:3px;
				text-align: center;
				line-height: 32px;
			}
			.list_of_friends_list img{
				width: 32px;
				height: 32px;
			}
			.mui-group-list-group {
			    background-color: #efefef;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav mheader">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left mback"></a>
		    <h1 class="mui-title mtitle" id="title" style="display:none;">通讯录</h1>
		    <div class="mui-title" id="jiazai" style="display:block;">
		    	<div class="chat-trip">
					<div class="mui-pull-loading mui-icon mui-spinner mui-visibility"></div>
					<span class="fs14 c666666">加载中...</span>
				</div>
		    </div>
		    <div class="fr tinajia" style="font-size: 21px;width: 50px;">
				<span class="fr iconfont icon--_xindepengyou c000000 mr5 fs21 mt10 "></span>
			</div>
			
		</header>
		<div class="mui-content">
			<div id='list' class="mui-group-list" style="background: #efefef;">
				<div class="mui-group-list-search mui-input-row mui-search bde5 borderr disn" style="margin: 10px;">
					<input id="input_search" style="background: #FFFFFF;" type="search" class="mui-input-clear mui-group-list-search-input" placeholder="搜索">
				</div>
				<div class="mt10">
					<ul  class="mui-table-view">
						<li class="mui-table-view-cell" id="newfriends">
							<div class="fl list_of_friends_d1 cffffff">
								<span class="iconfont icon--_xindepengyou fs17"></span>
							</div>
							<div class="fl fs14 lh30 ml10">
								<span>
									新的朋友
								</span>
								
							</div>
							<div id="tubiao" class="cffffff fs11 tubiao disn" style="position: absolute;top: 2px;left: 40px;background: red;border-radius:50%;height: 16px;width: 16px;z-index: 1000;">
								<span class="ml5" style="position: absolute;top: -2px;">1</span>
							</div>
						</li>
						<li class="mui-table-view-cell">
							<div class="fl list_of_friends_d2 cffffff">
								<span class="iconfont icon-qunliao fs22"></span>
							</div>
							<div class="fl fs14 lh30 ml10">
								群聊
							</div>
						</li>
					</ul>
				</div>
				<div class="mui-group-list-bar" style="margin-top: -60px;line-height: 10px;">
					<a>A</a>
					<a>B</a>
					<a>C</a>
					<a>D</a>
					<a>E</a>
					<a>F</a>
					<a>G</a>
					<a>H</a>
					<a>I</a>
					<a>J</a>
					<a>K</a>
					<a>L</a>
					<a>M</a>
					<a>N</a>
					<a>O</a>
					<a>P</a>
					<a>Q</a>
					<a>R</a>
					<a>S</a>
					<a>T</a>
					<a>U</a>
					<a>V</a>
					<a>W</a>
					<a>X</a>
					<a>Y</a>
					<a>Z</a>
				</div>
				<div class="mui-group-list-alert"></div>
				<div class="mui-group-list-inner" style="padding-bottom: 150px;" >
					<div class="mui-group-list-empty-alert">没有数据</div>
					<ul id="ul_city" class="mui-table-view">
						<!--<li data-group="A" class="mui-table-view-divider mui-group-list-group fs12 ">A</li>
						<li class="mui-table-view-cell mui-group-list-item">
							<div class="fl list_of_friends_list cffffff">
								<img src="../img/touxiang1.jpg" />
							</div>
							<div class="fl fs14 lh30 ml10">
								群聊
							</div>
						</li>
						<li class="mui-table-view-cell mui-group-list-item">安康市</li>
						<li class="mui-table-view-cell mui-group-list-item">安庆市</li>
						<li data-group="B" class="mui-table-view-divider mui-group-list-group fs12">B</li>
						<li class="mui-table-view-cell mui-group-list-item">巴彦淖尔市</li>
						<li class="mui-table-view-cell mui-group-list-item">巴中市</li>
						<li class="mui-table-view-cell mui-group-list-item">巴州</li>
						<li class="mui-table-view-cell mui-group-list-item">白城市</li>
						<li data-group="C" class="mui-table-view-divider mui-group-list-group fs12">C</li>
						<li class="mui-table-view-cell mui-group-list-item">cs</li>
						<li class="mui-table-view-cell mui-group-list-item">长沙</li>
						<li class="mui-table-view-cell mui-group-list-item">成都</li>-->
					</ul>
				</div>
			</div>
		</div>
		<script type="text/template" id="liebiao">
			{{each list}}
				<li data-group="{{$value.first}}" class="mui-table-view-divider mui-group-list-group fs12 ">{{$value.first}}</li>
				{{each $value.content}}
					<li class="mui-table-view-cell mui-group-list-item" data_item="{{$value}}" data-value="{{$value.nick}}" data_accid="{{$value.account}}">
						<div class="fl list_of_friends_list cffffff">
							<img src="{{$value.avatar}}" />
						</div>
						<div class="fl fs14 lh30 ml10">
							{{$value.nick}}
						</div>
					</li>
				{{/each}}
			{{/each}}
			
			
		</script>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript" src="../js/castapp.js" ></script>
		
		<script type="text/javascript" src="../js/NIM_Web_NIM_v5.5.0.js" ></script>
		<script type="text/javascript" src="../js/template-web.js" ></script>
		<script type="text/javascript">
			mui.init();
			ca.init();
			ca.blackStatusBar();
			var aa=['li','a','的','大萨达','#','abc'];
			var arr=[];
			mui.plusReady(function(){
				ca.closeWaitings();
				var account=localStorage.getItem('e_code')+'_'+localStorage.getItem('username');
				var nim = NIM.getInstance({
					  appKey:'fc06054e7594d0cd2e17b1238c9fc296',
					  account:localStorage.getItem('e_code')+'_'+localStorage.getItem('username'),
					  token:localStorage.getItem('im_token'),
					  onconnect:onConnect,
					  onwillreconnect:onWillReconnect,
					  ondisconnect:onDisconnect,
					  onerror:onError,
					  onofflinesysmsgs: onOfflineSysMsgs,
					  onsysmsg: onSysMsg,
					  onupdatesysmsg: onUpdateSysMsg,
					  onsysmsgunread:onsysmsgunread,
						onusers: onUsers
				});
				function onConnect(optional) {
				  console.log('连接成功');
				  // findAll();
				  ca.closeWaiting();
	//			  console.log(JSON.stringify(optional))
				}
				function onWillReconnect(obj) {
				  // 此时说明 SDK 已经断开连接, 请开发者在界面上提示用户连接已断开, 而且正在重新建立连接
				  console.log('即将重连');
				}
				function onDisconnect(error) {
				  // 此时说明 SDK 处于断开状态, 开发者此时应该根据错误码提示相应的错误信息, 并且跳转到登录页面
				  console.log('丢失连接');
				}
				function onError(error) {
				  console.log(error);
				}
				function onOfflineSysMsgs(sysMsgs) {
				    console.log('收到离线系统通知', sysMsgs);
				    pushSysMsgs(sysMsgs);
				}
				function onSysMsg(sysMsg) {
				    console.log('收到系统通知', sysMsg);
				    pushSysMsgss(sysMsg);
				}
				function onUpdateSysMsg(sysMsg) {
	//			    pushSysMsgs(sysMsg);
				}
				function onsysmsgunread(sysMsg){
//						alert(JSON.stringify(sysMsg));
				}
				function onUsers(users) {
					console.log('收到用户资料列表', users);
					// alert(JSON.stringify(users))
					findlist(users);
				}
				function findAll(){
					nim.getFriends({
				    	done: getFriendsDone
					});
					function getFriendsDone(error, friends) {
					    console.log('获取好友列表' + (!error?'成功':'失败'), error, friends);
					    if (!error && friends) {
					    	var arr={accids:[]};
					    	mui.each(friends,function(index,item){
					    		arr.accids.push(item.account);
					    	})
					    	ca.ajaxs({url:'findImFriendUsers',data:{
					    			parm:arr,user_id:localStorage.getItem('userid')
						    	},succFn:function(data){
						    		findlist(data);
						    		ca.closeWaiting();
						    	},errFn:function(call){
						    		mui.toast(call);
						    		ca.closeWaiting();
						    	}
					    	})
					    }
					}
				}
				
				
				
				function pushSysMsgss(sysMsg){
					if(sysMsg.type=='applyFriend'){
						var arrlist=JSON.parse(plus.storage.getItem(account+'new_friend'));
						var sysMsg=sysMsg;
						if(ca.emptyFun(arrlist)){
							nim.getUser({
						    	account:sysMsg.from,
						   	 	done: getUserDone1
							});
							function getUserDone1(error, user) {
							    if (!error) {
							    	if(user){
							    		var arr={
											unreadcount:1,
											content:[{
												friendaccount:user.account,
												friendname:user.nick,
												friendimg:user.avatar,
												friendtime:sysMsg.time,
												friendidserver:sysMsg.idServer,
												state:sysMsg.state,
												ps:sysMsg.ps
											}]
										}
							    		plus.storage.setItem(account+'new_friend',JSON.stringify(arr));
							    		show();
							    	}
							    }
							}
						}else{
							for(var a  in arrlist.content){
								if(arrlist.content[a].friendaccount==sysMsg.from){
									arrlist.content[a].friendtime=sysMsg.time;
									arrlist.content[a].ps=sysMsg.ps;
								}else if(a==arrlist.content.length-1){
									nim.getUser({
								    	account:sysMsg.from,
								   	 	done: getUserDone2
									});
									function getUserDone2(error, user) {
									    if (!error) {
									    	if(user){
									    		arrlist.unreadcount=arrlist.unreadcount+1;
									    		arrlist.content.push({
								    			friendaccount:user.account,
													friendname:user.nick,
													friendimg:user.avatar,
													friendtime:sysMsg.time,
													friendidserver:sysMsg.idServer,
													state:sysMsg.state,
													ps:sysMsg.ps
									    		})
									    		plus.storage.setItem(account+'new_friend',JSON.stringify(arrlist));
									    		show();
									    	}
									    }
									}
								}
							}
						}
					}
					
				}
					
					
			
				show();
				function show(){
					var arrlist=JSON.parse(plus.storage.getItem(account+'new_friend'));
				 	if(!ca.emptyFun(arrlist)){
				 		if(arrlist.unreadcount>0){
					 		ca.id('tubiao').style.display='block';
					 		ca.className('ml5')[0].innerText=arrlist.unreadcount;
				 		}
				 	}
				 	
				}
				
				ca.id('newfriends').addEventListener('tap',function(){
					mui.openWindow({
					    url:'new_friend_notification.html',
					    id:'new_friend_notification',
					    extras:{
					        account:account,
					    }
					});
					var arrlist=JSON.parse(plus.storage.getItem(account+'new_friend'));
					if(!ca.emptyFun(arrlist)){
						arrlist.unreadcount=0;
						plus.storage.setItem(account+'new_friend',JSON.stringify(arrlist));
					}
					ca.id('tubiao').style.display='none';
					
				})
				function findlist(data){
					var arr=[];
					if(data){
						mui.each(data,function(index,item){
							var uni=item.nick.charCodeAt(0);
							var shouzi='';
							if(uni > 40869 || uni < 19968){
					    		shouzi=item.nick.slice(0,1);
						    }else{
						    	//检查是否是多音字,是按多音字处理,不是就直接在strChineseFirstPY字符串中找对应的首字母  
						    	shouzi=(ca.oMultiDiffs(uni) ? ca.oMultiDiffs(uni) : ca.getFirstLetter(item.nick));
						    }
						    if(index==0){
						    	arr.push({first:shouzi,content:[item]});
						    }else{
						    	for(var a in arr){
						    		if(arr[a].first==shouzi){
						    			arr[a].content.push(item);
							    		arr.splice(a,1,arr[a]);
							    		break;
							    	}else if(a==arr.length-1){
							    		arr.push({first:shouzi,content:[item]});
							    	}
						    	}
						    }
						})
					 	var a=arr.sort(function(a,b){
							return a.first.localeCompare(b.first);
						})
						// alert(JSON.stringify(a));
					 	ca.id('ul_city').innerHTML=template('liebiao', {
							"list":a
						});
					 	
					}
					ca.id('jiazai').style.display='none';
					ca.id('title').style.display='block';
				}
			})
			
			
			mui('#ul_city').on('tap','.mui-group-list-item',function(){
				var accid=this.getAttribute('data_accid');
				var item=this.getAttribute('data_item');
				var use=JSON.parse(item);
				var user={
					avatar:use.avatar,
					nick:use.nick,
					gender:use.gender,
					account:use.account,
					tel:use.tel,
					email:use.email,
					birth:use.birth,
				}
				
				mui.openWindow({
				    url:'friend_detail.html',
				    id:'friend_detail',
				    extras:{
				       users:user
				    }
				});
			})
			
			
			
			
			


			mui.ready(function() {
				var header = document.querySelector('header.mui-bar');
				var list = document.getElementById('list');
				list.style.height = (document.body.offsetHeight - header.offsetHeight) + 'px';
				window.groupList = new mui.GroupList(list);
				//点击列表选择城市
//				var ul_city = document.getElementById('ul_city');
//				ul_city.addEventListener("tap", function(e) {
//					var tagClass = e.target.getAttribute("class");
//					console.log("tagClass==" + tagClass);
//					if (tagClass && tagClass.indexOf("mui-table-view-cell") != -1) {
//						var selectCity = e.target.innerText;
//						alert(selectCity);
//					}
//				});
		});
		
		ca.className('tinajia')[0].addEventListener('tap',function(){
			mui.openWindow({
			    url:'search_friends.html',
			    id:'search_friends',
			    extras:{
			       
			    }
			});
			
		})
		</script>
		<script src="../js/mui.indexedlist.js"></script>
	</body>
	
</html>