<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/style.css" />
		<link rel="stylesheet" href="../css/iconfont.css" />
		<link rel="stylesheet" href="../css/previewImage.css" />
		<link rel="stylesheet" href="../css/Upimg.css" />
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			.mui-slider{
				height: 100%;
				z-index: 999;
			}
			footer {
				position: fixed;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
				padding: 0px 50px;
				background-color: #fafafa;
				z-index: 10;
			}
			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			.footer-center {
				height: 100%;
				padding: 5px 0px;
			}
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			.footer-center .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
			}
			.footer-center .input-sound {
				background-color: #eee;
			}
			.mui-content {
				height: 100%;
				padding: 44px 0px 70px 0px;
				overflow: auto;
				background-color: #eaeaea;
			}
			#msg-list {
				height: 100%;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
			}
			.msg-item {
				padding: 8px;
				clear: both;
				overflow: hidden;
				
			}
			.msg-item .mui-item-clear {
				float: left;
				padding: 8px 1px;
			}
			.msg-item .mui-item-clear1 {
				float: right;
				padding: 8px 0px;
				color: red;
			}
			.msg-item .mui-item-clear2 {
				float: right;
				padding: 9px 0px;
				color: #B5B5B5;
				font-size:12px ;
			}
			.msg-item .mui-item-clear3 {
				float: left;
				padding: 9px 0px;
				color: #B5B5B5;
				font-size:12px ;
			}
			
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				border: solid 1px #d3d3d3;
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				padding: 3px;
				color: #ddd;
			}
			
			.msg-item .msg-user-img{
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
			}
			.msg-item .msg-user-img1{
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: right;
				color: #ddd;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px 0px 5px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			.msg-content-image{
				margin-left: 8px;
				border-radius: 5px;
				max-height: 150px;
				float: left;
			}
			.msg-content-image1{
				float: right;
				margin-right: 8px;
				border-radius: 5px;
				max-height: 150px;
			}
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
				/* -webkit-user-select: auto !important;
				user-select: all !important; */
			}
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			.msg-item-self .msg-user,
			.msg-item-self .msg-content {
				float: right;
			}
			.msg-item-self .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			.msg-item-self .msg-content,
			.msg-item-self .msg-content .msg-content-arrow {
				background-color: #4CD964;
				color: #fff;
				border-color: #2AC845;
			}
			footer .mui-icon {
				color: #000;
			}
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			footer .mui-icon-paperplane:before {
				content: "发送";
			}
			footer .mui-icon-paperplane {
				/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
				
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
				-webkit-transition: .15s;
			}
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			.r-sigh{
				display: none;
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				text-align: center;
				line-height: 46px;
				font-size: 40px;
				font-weight: bold;
				color: #2187e7;
			}
			.rprogress-sigh{
				background-image: none !important;
			}
			.rprogress-sigh .rschedule{
				display: none !important;
			}
			.rprogress-sigh .r-sigh{
				display: block !important;
			}
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			.cancel {
				background-color: darkred;
			}
			.mui-zoom-wrapper{
				max-height: 90%;
				margin-top: 5%;
			}
		</style>
	
	</head>

	<body>
		<header class="mui-bar mui-bar-nav mheader">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left mback"></a>
		    <h1 class="mui-title htitle">标题</h1>
		    <div id="jiahaoyou" class="fr tinajia disn" style="font-size: 21px;width: 50px;">
				<span class="fr iconfont icon--_xindepengyou c000000 mr5 fs21 mt10 "></span>
			</div>
		</header>
		<pre id='h'></pre>
			<div class="w100 tc disn" id="jiazaizi" style="position: absolute;top: 69px;z-index: 1000;">
				<div class="chat-trip">
					<div class="mui-pull-loading mui-icon mui-spinner mui-visibility"></div>
				</div>
			</div>
			<div id="a" class="mui-content">
				
			<!--<div class="msg-item  msg-item-self" >
				<img class="msg-user-img1" src="../img/banner1.jpg" />
				<div class="msg-content">
					<div class="msg-content-inner">
						132123一
					</div>
					<div class="msg-content-arrow"></div>
				</div>
				<div class="mui-item-clear1">
					<span class="iconfont icon-gantanhao"></span>
				</div>
			</div>
			<div class="msg-item" >
				<img class="msg-user-img" src="../img/banner1.jpg" />
				<div class="msg-content">
					<div class="msg-content-inner">
						132123二
					</div>
					<div class="msg-content-arrow"></div>
				</div>
				<div class="mui-item-clear">
					<div class="chat-trip">
						<div class="mui-pull-loading mui-icon mui-spinner mui-visibility"></div>
					</div>
				</div>
			</div>
			<div class="w100 tc">
				<span class="fs11 cffffff" style="background: #D0D0D0;border-radius:6px ;padding: 1px 4px;">昨天 15:30</span>
			</div>-->
		</div>
		<footer>
			<div class=" footer-left">
				<!--<input type="file" id="inputt"  onchange="getfilename(event);" />-->
				<i id='msg-image' class="mui-icon mui-icon-plus" style="font-size: 28px;"></i>
			</div>
			<div class="footer-center">
				<textarea id='msg-text' type="text" class='input-text'></textarea>
				<button id='msg-sound' type="button" class='input-sound' style="display: none;">按住说话</button>
			</div>
			<label for="" class=" footer-right">
				<i id='msg-type' class="mui-icon mui-icon-mic"></i>
			</label>
		</footer>
		<div class="disn bgwhite" id="dibu1" style="position: fixed;bottom: 0px;height: 100px;width: 100%;background: #FAFAFA;border-top:1px solid #ddd;">
				<div class="oh">
					<div class="w25 fl tc">
						<div style="width: 60%;background: #FFFFFF;padding: 12px 6px 9px 6px;margin-left: 20%;border: 1px solid #ddd;border-radius:5px ;" class="mt10">
							<span class="iconfont icon-zhaopian1 c999999" style="font-size: 28px;"></span>
						</div>
						<div class="mt3">
							<span class="fs12 c666666" style="">照片</span>
						</div>
					</div>
					<div class="w25 fl tc">
						<div style="width: 60%;background: #FFFFFF;padding: 13px 6px 10px 6px;margin-left: 20%;border: 1px solid #ddd;border-radius:5px ;" class="mt10">
							<span class="iconfont icon-zhaopian c999999" style="font-size: 24px;"></span>
						</div>
						<div class="mt3">
							<span class="fs12 c666666" style="">相机</span>
						</div>
					</div>
					
				</div>
		</div>
		<div id='sound-alert' class="rprogress">
			<div class="rschedule"></div>
			<div class="r-sigh">!</div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<div id="popover"  class="disn" style="z-index: 9999;position: absolute;background: #000000;width: 100px;height: 30px;border-radius:5px ;">
			<div class="fl fs13 tc cffffff fuzhi" style="border-right: 2px solid #EAEAEA;height: 30px;width: 50px;">
				<span>复制</span>
			</div>
			<div class="fl fs13 tc cffffff">
				<span>删除</span>
			</div>
		</div>
		<script type="text/javascript" src="../js/template-web.js" ></script>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript" src="../js/castapp.js" ></script>
		<script type="text/javascript" src="../js/NIM_Web_NIM_v5.5.0.js" ></script>
		<script type="text/javascript" src="../js/md5.js" ></script>
		<script type="text/javascript" src="../js/mui.previewimage.js"></script>
		<script type="text/javascript" src="../js/mui.zoom.js"></script>
		<script type="text/javascript" src="../js/mui.previewimage.span.js"></script>
		<script type="text/javascript">
			mui.init({
					gestureConfig: {
						tap: true, //默认为true
						doubletap: true, //默认为false
						longtap: true, //默认为false
						swipe: true, //默认为true
						drag: true, //默认为true
						hold: true, //默认为false，不监听
						release: true //默认为false，不监听
					}
				});
			ca.init();
			
			mui.previewImage();
			
			oldback();
			function oldback(){
				mui.back = function() {
					localStorage.removeItem('accounts');
					var arr1 = ['im_list'];
					ca.sendNotice(arr1,'update',{});
					var ws=plus.webview.currentWebview();
					plus.webview.close(ws);
				}
			}
			ca.blackStatusBar();
			var MIN_SOUND_TIME = 800;
			if(mui.os.ios){
					// 解决在ios上fixed元素focusin时位置出现错误的问题 
					document.addEventListener('DOMContentLoaded',function(){
						var footerDom = document.querySelector('footer');
						
						document.addEventListener('focusin', function() {
							footerDom.style.position = 'absolute';
						});
						document.addEventListener('focusout', function() {
							footerDom.style.position = 'fixed';
						});
					});
			}
			mui.plusReady(function(){
				var self = plus.webview.currentWebview();
				// alert(JSON.stringify(self))
				// self.setStyle({userSelect:false});
				var accounts = self.accounts;
				var account=localStorage.getItem('e_code')+'_'+localStorage.getItem('username');
				var storageName='chatList'+account+'and'+accounts;
				var chatlist=JSON.parse(plus.storage.getItem(storageName));
				// alert(JSON.stringify(chatlist))
				var fasong=[];
				var page=1;
				var isjiazai=false;
				var chatlistcontentindex=0;
				ca.className('htitle')[0].innerText=self.name;
				var nim = NIM.getInstance({
					  // debug: true,
					  appKey:'fc06054e7594d0cd2e17b1238c9fc296',
					  account:account,
					  token:localStorage.getItem('im_token'),
					  // privateConf: {}, // 私有化部署方案所需的配置
// 						onconnect:onConnect,
// 					  onwillreconnect:onWillReconnect,
// 					  ondisconnect:onDisconnect,
// 					  onerror:onError,
						onroamingmsgs: onRoamingMsgs,
						onofflinemsgs: onOfflineMsgs,
						onmsg: onMsg,
						onfriends: onFriends
				});
				if(ca.emptyFun(chatlist)){//检查用户聊天信息  无  创建  
					var chat=new Object;
					chat.selfuserid=localStorage.getItem('userid');
					chat.selfname=localStorage.getItem('realname');
					chat.selfimg=localStorage.getItem('userimg_url');
					chat.selfaccount=account;
					chat.heuserid=1;
					chat.hename=self.name;
					chat.heimg=self.userimg;
					chat.heaccount=accounts;
					chat.updatetime=new Date().getTime();
					chat.content=[];
					plus.storage.setItem(storageName,JSON.stringify(chat));
					chatlist=JSON.parse(plus.storage.getItem(storageName));
				}else{//有  更新
// 					if(new Date().getTime()-chatlist.updatetime>=1000){
// 						nim.getUser({
// 								account: account,
// 								done: getUserDone
// 						});
// 						function getUserDone(error, user) {
// 							alert(error)
// 								console.log('获取用户资料' + (!error?'成功':'失败'));
// 								if (!error) {
// 									chatlist.selfuserid=localStorage.getItem('userid');
// 									chatlist.selfname=user.nick;
// 									chatlist.selfimg=user.avatar;
// 									chatlist.selfaccount=account;
// 									chatlist.heuserid=1;
// 									chatlist.hename=self.name;
// 									chatlist.heimg=self.userimg;
// 									chatlist.heaccount=accounts;
// 									chatlist.updatetime=new Date().getTime();
// 									plus.storage.setItem(storageName,JSON.stringify(chatlist));
// 									chatlist=JSON.parse(plus.storage.getItem(storageName));
// 								}
// 						}
// 						shuju(page);
// 					}
					
				}
				plus.webview.currentWebview().setStyle({
					softinputMode: "adjustResize"
				});
				var showKeyboard = function() {
					if (plus.os.name=='iOS') {
						var webView = plus.webview.currentWebview().nativeInstanceObject();
						webView.plusCallMethod({
							"setKeyboardDisplayRequiresUserAction": false
						});
					} else {
						var Context = plus.android.importClass("android.content.Context");
						var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
						var main = plus.android.runtimeMainActivity();
						var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
						imm.toggleSoftInput(0, InputMethodManager.HIDE_NOT_ALWAYS);
						//var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
						imm.showSoftInput(main.getWindow().getDecorView(), InputMethodManager.SHOW_IMPLICIT);
						//alert("ll");
					}
				};
				var ui = {
					body: document.querySelector('body'),
					footer: document.querySelector('footer'),
					footerRight: document.querySelector('.footer-right'),
					footerLeft: document.querySelector('.footer-left'),
					btnMsgType: document.querySelector('#msg-type'),
					boxMsgText: document.querySelector('#msg-text'),
					boxMsgSound: document.querySelector('#msg-sound'),
					btnMsgImage: document.querySelector('#msg-image'),
					areaMsgList: document.querySelector('#a'),
					boxSoundAlert: document.querySelector('#sound-alert'),
					h: document.querySelector('#h'),
					content: document.querySelector('.mui-content')
				};
				ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
				var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;
				function msgTextFocus() {
					ui.boxMsgText.focus();
					setTimeout(function() {
						ui.boxMsgText.focus();
					}, 10);
				}
				//发送文字消息
				ui.footerRight.addEventListener('release', function(event) {
					ca.id('dibu1').style.display='none';
					istrue=true;
					ui.footer.style.bottom=0+'px';
					if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
//						showKeyboard();
// 						ui.boxMsgText.focus();
// 						setTimeout(function() {
// 							ui.boxMsgText.focus();
// 						}, 1);
						var msg = nim.sendText({
						    scene: 'p2p',
						    to: accounts,
						    text: ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>'),
						    isPushable:true,
						    needPushNick:true,
						    isMuted:false,
						    done: sendMsgDone
						});
						ui.boxMsgText.value = '';
						mui.trigger(ui.boxMsgText, 'input', null);
					} else if (ui.btnMsgType.classList.contains('mui-icon-mic')) {
						ui.btnMsgType.classList.add('mui-icon-compose');
						ui.btnMsgType.classList.remove('mui-icon-mic');
						ui.boxMsgText.style.display = 'none';
						ui.boxMsgSound.style.display = 'block';
						ui.boxMsgText.blur();
						document.body.focus();
//						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					} else if (ui.btnMsgType.classList.contains('mui-icon-compose')) {
						ui.btnMsgType.classList.add('mui-icon-mic');
						ui.btnMsgType.classList.remove('mui-icon-compose');
						ui.boxMsgSound.style.display = 'none';
						ui.boxMsgText.style.display = 'block';
						//--
						//showKeyboard();
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 150);
					}
				}, false);
				//输入文字时调用
				ui.boxMsgText.addEventListener('input', function(event) {
					ca.id('dibu1').style.display='none';
					istrue=true;
					ui.footer.style.bottom=0+'px';
					ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');
					ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');
					ui.h.innerText = ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '\n-') || '-';
					ui.footer.style.height = (ui.h.offsetHeight + footerPadding) + 'px';//随字数设置text的高度
					ui.content.style.paddingBottom = ui.footer.style.height+30;
				});
				//点击文本框
				ui.boxMsgText.addEventListener('tap', function(event) {
					ca.id('dibu1').style.display='none';
					istrue=true;
					ui.content.style.paddingBottom=80+'px';
					ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					ui.footer.style.bottom=0+'px';
					ui.boxMsgText.focus();
					setTimeout(function() {
						ui.boxMsgText.focus();
					}, 0);
					focus = true;
					setTimeout(function (){
						focus = false;
					},1000);
					event.detail.gesture.preventDefault();
				}, false);
				var istrue=true;
				//切换工具台
				ui.btnMsgImage.addEventListener('tap',function(){
					if(istrue){
						ui.boxMsgText.blur();
						ui.content.style.paddingBottom=180+'px';
						ui.footer.style.bottom=100+'px';
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight+180;
						ca.id('dibu1').style.display='block';
						istrue=false;
					}else{
						ui.content.style.paddingBottom=80+'px';
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
						ui.footer.style.bottom=0+'px';
						ca.id('dibu1').style.display='none';
						istrue=true;
					}
				})
				ca.className('w25')[0].addEventListener('tap',function(){
					galleryImgs(5);
				})
				ca.className('w25')[1].addEventListener('tap',function(){
					dongyi.camera({
						succFn:function(path,name){
							insertPhoto(path);
						}
					});
				})
				// 从相册中选择多张图片 
						function galleryImgs( num ){
								// 从相册中选择图片
								console.log("从相册中选择多张图片:");
								plus.gallery.pick( function(e){
												for(var i in e.files){
														console.log( e.files[i] );
														insertPhoto( e.files[i] ); //将图片放在页面上
												}
								},function (e) {
												console.log( "取消选择图片" );
								},{ 
												filter   : "image",     //系统相册选择器中可选择的文件类型 "image" , "video" , "none"
												multiple : true,        //是否支持多选
												maximum  : num,         //最多选择的文件数量，上面设置了全局变量
												system   : false,       //是否使用系统文件选择界面，iOS下无效
												onmaxed  : function(){  //超出选择最大文件数时触发
												mui.toast( '最多选择' + num + '张图片' )
										}
								});
						}
						
						
						
						//将选择的图片转base64并加入到页面中
						function insertPhoto (data){
							plus.io.resolveLocalFileSystemURL(data,function(entry){ 
								entry.file(function(file){  
								EncapsulationMessage('out',new Date().getTime(),'image','sending','',file.fullPath);
								fasong.push(chatlist.content.length);
								   var fileReader = new plus.io.FileReader();  
								   fileReader.readAsDataURL(file);  
								   fileReader.onloadend = function(e) {
										// alert(e.target.result)
										var bo=dataURLtoBlob(e.target.result);
										nim.sendFile({
												scene: 'p2p',
												to: accounts,
												type: 'image',
												blob: bo,
												beginupload: function(upload) {
												},
												uploadprogress: function(obj){
												},
												uploaddone: function(error, fi) {
													console.log('上传' + (!error?'成功':'失败'));
													if(error){
														var index='';
														for(var a in chatlist.content){
															if(chatlist.content[a].id==fasong[0]){
																	index=a;
																	break;
																}
														}
														var ob={
															id:fasong[0],
															flow:'out',
															time:new Date().getTime(),
															type:'image',
															status:'fail',
															content:'',
															fileurl:file.fullPath,
															dur:0
														}
														chatlist.content.splice(index,1,ob);
														plus.storage.setItem(storageName,JSON.stringify(chatlist));
														ca.id(fasong[0]).innerHTML='<img class="msg-user-img1" src="'+chatlist.selfimg+'" /><img class="msg-content-image1" src="'+file.fullPath+'" style="max-width: 100px;" data-preview-src="" data-preview-group="1"/><div class="mui-item-clear1" style="margin-right:5px"><span class="iconfont icon-gantanhao"></span></div>'
														fasong=[];
													}	
												},
												beforesend: function(msg) {
														console.log('正在发送p2p image消息, id=' + msg.idClient);
														//pushMsg(msg);
												},
												done: sendMsgDone
										});
								   }
								});  
							});  
							
							
							
							
							
							
							
							
// 								//创建image对象并转换base64码
// 								var img = new Image();
// 								img.src = data;
// 								img.onload = function(){
// 										//创建canvas画布
// 										var canvas = document.createElement("canvas"); 
// 										//在css中不要直接给img设置宽高,否则此处会获取到css设置的值
// 										var width  = img.width;
// 										var height = img.height;
// 										//比较图片宽高设置图片显示和canvas画布尺寸
// 										if (width > height) { 
// 												if (width > 500) { 
// 														height = Math.round(height *= 500 / width); 
// 														width = 500; 
// 												} 
// 										} else { 
// 												if (height > 500) { 
// 														width = Math.round(width *= 500 / height); 
// 														height = 500; 
// 												} 
// 										} 
// 										canvas.width  = width;                               //设置新的图片的宽度
// 										canvas.height = height;                              //设置新的图片的长度
// 										var ctx = canvas.getContext("2d"); 
// 										ctx.drawImage(img, 0, 0, width, height);             //绘图
// 										
// 										var dataURL = canvas.toDataURL("image/jpeg", 1);
// 										
// 										var bo=dataURLtoBlob(dataURL);
// 										
// 										nim.sendFile({
// 												scene: 'p2p',
// 												to: accounts,
// 												type: 'image',
// 												blob: bo,
// 												beginupload: function(upload) {
// 														// - 如果开发者传入 fileInput, 在此回调之前不能修改 fileInput
// 														// - 在此回调之后可以取消图片上传, 此回调会接收一个参数 `upload`, 调用 `upload.abort();` 来取消文件上传
// 												},
// 												uploadprogress: function(obj){
// 												},
// 												uploaddone: function(error, file) {
// 														console.log('上传' + (!error?'成功':'失败'));
// 												},
// 												beforesend: function(msg) {
// 														console.log('正在发送p2p image消息, id=' + msg.idClient);
// 														//pushMsg(msg);
// 												},
// 												done: sendMsgDone
// 										});
// 								}
						}
				function createDownload1(urls,msg) {
								var filename='';
								var dtask = plus.downloader.createDownload(urls, {filename:'_downloads/'+new Date().getTime()+'.png'}, function ( d, status ) {
									// 下载完成
									if ( status == 200 ) { 
										showPics(d.filename,msg);
									} else {
										
									}  
								});
								dtask.start(); 
								// alert(JSON.stringify(dtask))
								// dtask.addEventListener( "statechanged", onStateChanged, false );
							}
							
							
							function showPics(url,msg){          
				         	//根据路径读取到文件   
					           plus.io.resolveLocalFileSystemURL(url,function(entry){  
					               entry.file(function(file){
													 if(msg.flow=='out'){
														var index='';
														for(var a in chatlist.content){
															if(chatlist.content[a].id==fasong[0]){
																	index=a;
																	break;
																}
														}
														 var ob={
														 	id:fasong[0],
														 	flow:msg.flow,
														 	time:msg.time,
														 	type:msg.type,
														 	status:msg.status,
														 	content:'',
														 	fileurl:file.fullPath,
														 	dur:0
														 }
														 chatlist.content.splice(index,1,ob);
														 plus.storage.setItem(storageName,JSON.stringify(chatlist));
														 ca.id(fasong[0]).innerHTML='<img class="msg-user-img1" src="'+chatlist.selfimg+'" /><img class="msg-content-image1" src="'+file.fullPath+'" style="max-width: 100px;" data-preview-src="" data-preview-group="1"/>'
														 fasong=[];
													 }else{
														 EncapsulationMessage(msg.flow,msg.time,msg.type,msg.status,'',file.fullPath);
													 }
													 
													 // 
// 					                   var fileReader = new plus.io.FileReader();  
// 					                   fileReader.readAsDataURL(file);  
// 					                   fileReader.onloadend = function(e) {
// 															 // alert(e.target.result)
// 						                   
// 					                   }
					               });  
					          });   
				       		}  
				
				
				
				
				var recordCancel = false;
				var recorder = null;
				var audio_tips = document.getElementById("audio_tips");
				var startTimestamp = null;
				var stopTimestamp = null;
				var stopTimer = null;
				//发送语音消息
				ui.boxMsgSound.addEventListener('hold', function(event) {
						recordCancel = false;
						if(stopTimer)clearTimeout(stopTimer);
						audio_tips.innerHTML = "手指上划，取消发送";
						ui.boxSoundAlert.classList.remove('rprogress-sigh');
						setSoundAlertVisable(true);
						recorder = plus.audio.getRecorder();
						if (recorder == null) {
							plus.nativeUI.toast("不能获取录音对象");
							return;
						}
						startTimestamp = (new Date()).getTime();
						recorder.record({
							filename: "_doc/audio/",format:"mp3"
						}, function(path) {
							if (recordCancel) return;
							Audio2dataURL(path);
						}, function(e) {
							plus.nativeUI.toast("录音时出现异常: " + e.message);
						});
					}, false);
					ui.body.addEventListener('drag', function(event) {
						//console.log('drag');
						if (Math.abs(event.detail.deltaY) > 50) {
							if (!recordCancel) {
								recordCancel = true;
								if (!audio_tips.classList.contains("cancel")) {
									audio_tips.classList.add("cancel");
								}
								audio_tips.innerHTML = "松开手指，取消发送";
							}
						} else {
							if (recordCancel) {
								recordCancel = false;
								if (audio_tips.classList.contains("cancel")) {
									audio_tips.classList.remove("cancel");
								}
								audio_tips.innerHTML = "手指上划，取消发送";
							}
						}
					}, false);
					ui.boxMsgSound.addEventListener('release', function(event) {
						//console.log('release');
						if (audio_tips.classList.contains("cancel")) {
							audio_tips.classList.remove("cancel");
							audio_tips.innerHTML = "手指上划，取消发送";
						}
						//
						stopTimestamp = (new Date()).getTime();
						if (stopTimestamp - startTimestamp < MIN_SOUND_TIME) {
							audio_tips.innerHTML = "录音时间太短";
							ui.boxSoundAlert.classList.add('rprogress-sigh');
							recordCancel = true;
							stopTimer=setTimeout(function(){
								setSoundAlertVisable(false);
							},800);
						}else if(stopTimestamp - startTimestamp >60000){
							audio_tips.innerHTML = "录音时间太长";
						}else{
							setSoundAlertVisable(false);
						}
//						alert(stopTimestamp - startTimestamp);
						recorder.stop();
					}, false);
					ui.boxMsgSound.addEventListener("touchstart", function(e) {
						//console.log("start....");
						e.preventDefault();
					});
				
				
				
				
				
				
				
				
				//初始数据
				shuju(page);
				mui.ready(function () {
					setTimeout(function(){
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					},500)
					
        })
//				var bindMsgList = function() {
//					if(!ca.emptyFun(chatlist.content)){
//						shuju(page);
//					}
//					
//				};
//				bindMsgList();
				var setSoundAlertVisable=function(show){
					if(show){
						ui.boxSoundAlert.style.display = 'block';
						ui.boxSoundAlert.style.opacity = 1;
					}else{
						ui.boxSoundAlert.style.opacity = 0;
						//fadeOut 完成再真正隐藏
						setTimeout(function(){
							ui.boxSoundAlert.style.display = 'none';
						},200);
					}
				};
				//点击消息内容
				var msgItemTap = function(msgItem, event) {
					var msgType = msgItem.getAttribute('msg-type');
					var msgContent = msgItem.getAttribute('msg-content');
					if (msgType == 'audio') {
						alert(msgContent)
						player = plus.audio.createPlayer(msgContent);
						var playState = msgItem.querySelector('.play-state');
						playState.innerText = '正在播放...';
						player.play(function() {
							playState.innerText = '点击播放';
						}, function(e) {
							playState.innerText = '点击播放';
						});
					}
				};
				
				ca.id('a').addEventListener('scroll',function (e){
//					console.log(getScrollTop());console.log(getClientHeight());console.log(getScrollHeight())
							ca.id('popover').style.display='none';
			      	if(getScrollTop()<50 &&getScrollTop()>=0) {
			      		if(!isjiazai){
			      			 page++;
							console.log('正在加载更多');
							ca.id('jiazaizi').style.display='block';
							shuju(page);
							isjiazai=true;
			      		}
				    }
				})
				
				//获取当前可视范围的高度  
				function getClientHeight(){
				    var clientHeight = 0;
				    if(ca.id('a').clientHeight && document.documentElement.clientHeight) {
				        clientHeight = Math.min(ca.id('a').clientHeight, document.documentElement.clientHeight);
				    } else {
				        clientHeight = Math.max(ca.id('a').clientHeight, document.documentElement.clientHeight);
				    }
				    return clientHeight;
				}
				
				
				//获取滚动条当前的位置
			    function  getScrollTop() {
			        var scrollTop = 0;
			        if (document.documentElement && document.documentElement.scrollTop) {
			            scrollTop = document.documentElement.scrollTop;
			        }
			        else if (document.body) {
			            scrollTop = ca.id('a').scrollTop;
			        }
			        return scrollTop;
			    };
				//获取文档完整的高度 
				function getScrollHeight() {
				    return Math.max(ca.id('a').scrollHeight, document.documentElement.scrollHeight);
				}
				
				
				  
			//滚动到最底部
			window.addEventListener('resize', function() {
				if(plus.os.name=='iOS'){
					ca.id('a').style.paddingBottom='80px';
					ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight+30;
				}else{
					ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight+50;
				}
				
			}, false);
				
				
			
			
			function shuju(page){
				var data=ca.pagination(page,13,chatlist.content);
				if(!ca.emptyFun(data)){
					if(page>1){
						show(data.sort(ca.getSortFun('desc','time')),page);
						setTimeout(function(){
							isjiazai=false;
							ca.id('jiazaizi').style.display='none';
						},1000);
					}else{
						show(data.sort(ca.getSortFun('asc','time')),page); 
					}
				}else{
					isjiazai=true;
					ca.id('jiazaizi').style.display='none';
//					mui.toast('无更多数据!')
				}
//				onclickMsgItem();
			}
			//点击播放语音
			mui('.mui-content').on('tap','.msg-content',function(){
				var msgType = this.getAttribute('msg-type');
				var msgContent = this.getAttribute('msg-content');
				if (msgType == 'audio') {
					player = plus.audio.createPlayer(msgContent);
					var playState = this.querySelector('.play-state');
					playState.innerText = '正在播放...';
					player.play(function() {
						playState.innerText = '点击播放';
					}, function(e) {
						playState.innerText = '点击播放';
					});
				}
			})
			
			function onclickMsgItem(){
				var msgItems = ui.areaMsgList.querySelectorAll('.msg-content');
				[].forEach.call(msgItems, function(item, index) {
					item.addEventListener('tap', function(event) {
						msgItemTap(item, event);
					}, false);
				});
			}
			
			
			
			
			var datetime=0;
			var scrollHeights=ui.areaMsgList.scrollHeight;
			function show(data,page){
				scrollHeights=ui.areaMsgList.scrollHeight;
				var aa=data.length;
				for(var a in data){
					var temp2=document.createElement('div');
					var temp1=messageTemplates(data[a]);
					if(page>1){
						if(a==(aa-1)){
							var date = new Date(data[a].time);
							var aaa=ca.thisTimeForm(date.getHours(),date)
							temp2.innerHTML='<div class="w100 tc">'
								+'<span class="fs11 cffffff" style="background: #D0D0D0;border-radius:6px ;padding: 1px 4px;">'+aaa+'</span>'
								+'</div>';
						}else{
							if(datetime-data[a].time>600000){
							var date = new Date(data[a].time);
							var aaa=ca.thisTimeForm(date.getHours(),date)
							temp2.innerHTML='<div class="w100 tc">'
								+'<span class="fs11 cffffff" style="background: #D0D0D0;border-radius:6px ;padding: 1px 4px;">'+aaa+'</span>'
								+'</div>';
							}
						}
						ca.id('a').insertBefore(temp1,ca.id('a').firstChild);
						ca.id('a').insertBefore(temp2,ca.id('a').firstChild);
						if(a==(aa-1) && aa>0){
							ui.areaMsgList.scrollTop=ui.areaMsgList.scrollHeight-scrollHeights;
						}
					}else{
						if(a==0){
							var date = new Date(data[a].time);
							var aaa=ca.thisTimeForm(date.getHours(),date)
							temp2.innerHTML='<div class="w100 tc">'
								+'<span class="fs11 cffffff" style="background: #D0D0D0;border-radius:6px ;padding: 1px 4px;">'+aaa+'</span>'
								+'</div>';
							ca.id('a').appendChild(temp2);
						}else{
							if(data[a].time-datetime>600000){
								var date = new Date(data[a].time);
								var aaa=ca.thisTimeForm(date.getHours(),date)
								temp2.innerHTML='<div class="w100 tc">'
									+'<span class="fs11 cffffff" style="background: #D0D0D0;border-radius:6px ;padding: 1px 4px;">'+aaa+'</span>'
									+'</div>';
									
								ca.id('a').appendChild(temp2);
							}
						}
						ca.id('a').appendChild(temp1);
						ui.areaMsgList.style.paddingBottom=80+'px';
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					}
					datetime=data[a].time;
				}
				
			}
// 					function onConnect(optional) {
// 						console.log('连接成功');
// 		//			  console.log(JSON.stringify(optional))
// 					}
// 					function onWillReconnect(obj) {
// 						// 此时说明 SDK 已经断开连接, 请开发者在界面上提示用户连接已断开, 而且正在重新建立连接
// 		//			  console.log('即将重连');
// 					}
// 					function onDisconnect(error) {
// 						// 此时说明 SDK 处于断开状态, 开发者此时应该根据错误码提示相应的错误信息, 并且跳转到登录页面
// 						console.log('丢失连接');
// 						console.log(error);
// 					}
// 					function onError(error) {
// 						console.log(error);
// 					}
				
				function onRoamingMsgs(obj) {
				    console.log('收到漫游消息', obj);
				}
				function onOfflineMsgs(obj){
				    console.log('收到离线消息', obj);
				    
				}
				//收到消息
				function onMsg(msg) {
				    switch (msg.scene) {
				    case 'p2p':
				        onCustomMsg(msg);
				        break;
				    case 'notification':
				        // 处理群通知消息
				        onTeamNotificationMsg(msg);
				        break;
				    // 其它case
				    default:
				        break;
				    }
				}
				function onFriends(friends) {
					if(!ca.emptyFun(friends)){
						for(var a  in friends){
								if(accounts==friends[a].account){
									break;
								}else if(a==friends.length-1){
									ca.id('jiahaoyou').style.display='block';
								}
							}
					}else{
						ca.id('jiahaoyou').style.display='block';
					}
					
				}
				
				//收到消息处理
				function onCustomMsg(msg) {
					if(msg.target==accounts){
							if(msg.type=='audio'){
								createDownload(msg.file.url,msg);
							}
							else if(msg.type=='image'){
								// if(plus.os.name=="iOS"){
									createDownload1(msg.file.url,msg);
// 								}else{
// 									EncapsulationMessage(msg.flow,msg.time,msg.type,msg.status,'',msg.file.url,0)
// 								}
								
							}
							else{
								EncapsulationMessage(msg.flow,msg.time,msg.type,msg.status,msg.text,'fileurl',0)
								
							}
						}
//					alert(JSON.stringify(msg));
					
					
				}
				//发送消息回调
				function sendMsgDone(error, msg) {
					// alert(JSON.stringify(msg))
					if(msg.type=='audio'){
						createDownload(msg.file.url,msg);
					}
					else if(msg.type=='image'){
						// if(plus.os.name=="iOS"){
							createDownload1(msg.file.url,msg);
// 						}else{
// 							EncapsulationMessage(msg.flow,msg.time,msg.type,msg.status,'',msg.file.url)
// 						}
					}
					else{
						EncapsulationMessage(msg.flow,msg.time,msg.type,msg.status,msg.text,'fileurl');
						
					}
				}
				//加好友
				ca.id('jiahaoyou').addEventListener('tap',function(){
					alert(accounts)
					mui.openWindow({
					    url:'add_friend.html',
					    id:'add_friend',
					    extras:{
					        accounts:accounts
					    }
					});
					
				})
				
				mui('.mui-content').on('tap','.icon-gantanhao',function(){
					var type=this.parentElement.parentElement.getAttribute('data_type');
					var cont=this.parentElement.parentElement.getAttribute('data_content');
					var contenid=this.parentElement.parentElement.getAttribute('id');
					if(cont){
						var btnArray = ['是','否'];
						mui.confirm('重新发送？','提示',btnArray,function(e){
							if(e.index==0){
								if(type=='image'){
									insertPhoto('file://'+cont);
								}
								   
							}
						});
					}
				})
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				function Audio2dataURL (path) {
			    plus.io.resolveLocalFileSystemURL(path, function(entry){
			        entry.file(function(file){
			            var reader = new plus.io.FileReader();
			            reader.onloadend = function (e) {
			            	var bo=dataURLtoBlob(e.target.result);
			            	nim.sendFile({
												scene: 'p2p',
												to: accounts,
												type: 'audio',
												blob: bo,
												beginupload: function(upload) {
														// - 如果开发者传入 fileInput, 在此回调之前不能修改 fileInput
														// - 在此回调之后可以取消图片上传, 此回调会接收一个参数 `upload`, 调用 `upload.abort();` 来取消文件上传
												},
												uploadprogress: function(obj) {
														console.log('文件总大小: ' + obj.total + 'bytes');
														console.log('已经上传的大小: ' + obj.loaded + 'bytes');
														console.log('上传进度: ' + obj.percentage);
														console.log('上传进度文本: ' + obj.percentageText);
												},
												uploaddone: function(error, file) {
														console.log('上传' + (!error?'成功':'失败'));
														if(error){
															EncapsulationMessage('out',new Date().getTime(),'audio','fail','',path,0);
														}
												},
												beforesend: function(msg) {
														console.log('正在发送p2p image消息, id=' + msg.idClient);
												},
												done: sendMsgDone
										});
			                // console.log(e.target.result);
			            };
			            reader.readAsDataURL(file);
			        },function(e){
			            mui.toast("读写出现异常: " + e.message );
			        })
			    })
			}
			
			/* 工具方法：dataURL(base64字符串)转换为Blob对象（二进制大对象） */
	        //data:image/png;base64,iVBORw0KGgoAAAANSUhEUg......
	        function dataURLtoBlob(dataurl) {
	            var arr = dataurl.split(',');
	            var mime = arr[0].match(/:(.*?);/)[1];// 结果：   image/png
	            console.log("arr[0]====" + JSON.stringify(arr[0]));//   "data:image/png;base64"
	            console.log("arr[0].match(/:(.*?);/)====" + arr[0].match(/:(.*?);/));// :image/png;,image/png
	            console.log("arr[0].match(/:(.*?);/)[1]====" + arr[0].match(/:(.*?);/)[1]);//   image/png
	            var bstr = atob(arr[1].replace(/\s/g, ''));
	            var n = bstr.length;
	            var u8arr = new Uint8Array(n);
	            while (n--) {
	                u8arr[n] = bstr.charCodeAt(n);
	            }
	            return new Blob([u8arr], {type: mime});//值，类型
	        }
			
			function createDownload(urls,msg) {
				var dtask = plus.downloader.createDownload(urls, {},function (d, status) {
					// 下载完成
					if ( status == 200 ) { 
						EncapsulationMessage(msg.flow,msg.time,msg.type,msg.status,'',d.filename,msg.file.dur);
					} else {
//						 alert( "Download failed: " + status ); 
					}  
				});
				dtask.start();
			}
				/*
				 * 封装消息
				 */
				function EncapsulationMessage(flow,time,type,status,content,fileurl,dur){
						var ob={
							id:chatlist.content.length+1,
							flow:flow,
							time:time,
							type:type,
							status:status,
							content:content,
							fileurl:fileurl,
							dur:dur
						}
						chatlist.content.unshift(ob);
						plus.storage.setItem(storageName,JSON.stringify(chatlist));
						ca.id('a').appendChild(messageTemplates(ob));
						if(type=='image'){
							// ui.content.style.paddingBottom=210+'px';
							ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight+100;
						}else{
							ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
						}
						
					
					
				}
				// plus.storage.removeItem(storageName);
				// alert(unescape(encodeURIComponent(JSON.stringify(plus.storage.getItem(storageName)))).length);
				/**
				 * 消息模板
				 * @param {Object} data
				 */
				function messageTemplates(data){
					// alert(chatlist.selfimg)
					var id=chatlist.content.length;
					var temp1=document.createElement('div'),temp2=document.createElement('div'),temp3='';
					var dur=Math.round(data.dur/1000);
					if(data.flow=='out'){
						if(data.status=='fail'){
							temp3='<div class="mui-item-clear1"><span class="iconfont icon-gantanhao"></span></div>';
						}if(data.status=='sending'){
							temp3='<div class="mui-item-clear1"><div class="chat-trip"><div class="mui-pull-loading mui-icon mui-spinner mui-visibility"></div></div></div>';
						}
						if(data.type=='text'){
							temp1.innerHTML='<div class="msg-item  msg-item-self" data_type="'+data.type+'" data_content="'+data.content+'" id="'+id+'">'
								+	'<img class="msg-user-img1" src="'+chatlist.selfimg+'" />'
								+	'<div class="msg-content">'
								+		'<div class="msg-content-inner">'+data.content+'</div>'
								+		'<div class="msg-content-arrow"></div>'
								+	'</div>'
								+	temp3
								+'</div>';
						}else if(data.type=='audio'){
							temp3='<div class="mui-item-clear2">'+dur+'"</div>';
							temp1.innerHTML='<div class="msg-item  msg-item-self" data_type="'+data.type+'" data_content="'+data.fileurl+'" id="'+id+'">'
								+	'<img class="msg-user-img1" src="'+chatlist.selfimg+'" />'
								+	'<div class="msg-content" style="width:'+dur*1+'%;min-width:15%;max-width:60%;" msg-type="'+data.type+'" msg-content="'+data.fileurl+'">'
								+		'<span class="mui-icon mui-icon-mic fr" style="font-size: 18px;font-weight: bold;"></span>'
								+		'<span class="play-state disn">点击播放</span>'
								+	'</div>'
								+	temp3
								+'</div>';
							
							
						}else if(data.type=='image'){
							temp1.innerHTML='<div class="msg-item msg-item-self" data_content="'+data.fileurl+'" data_type="'+data.type+'" id="'+id+'">'
								+	'<img class="msg-user-img1" src="'+chatlist.selfimg+'" />'
								+	'<img class="msg-content-image1" src="'+data.fileurl+'" style="max-width: 100px;" data-preview-src="" data-preview-group="1"/>'
								+	temp3
								+'</div>';
						}
					}else{
						if(data.status=='fail'){
							temp3='<div class="mui-item-clear"><span class="iconfont icon-gantanhao"></span></div>';
						}if(data.status=='sending'){
							temp3='<div class="mui-item-clear"><div class="chat-trip"><div class="mui-pull-loading mui-icon mui-spinner mui-visibility"></div></div></div>';
						}
						if(data.type=='text'){
							temp1.innerHTML='<div class="msg-item" id="'+id+'">'
								+	'<img class="msg-user-img" src="'+chatlist.heimg+'" />'
								+	'<div class="msg-content">'
								+		'<div class="msg-content-inner">'+data.content+'</div>'
								+		'<div class="msg-content-arrow"></div>'
								+	'</div>'
								+	temp3
								+'</div>';
						}else if(data.type=='audio'){
							temp3='<div class="mui-item-clear3">'+dur+'"</div>';
							temp1.innerHTML='<div class="msg-item " id="'+id+'">'
								+	'<img class="msg-user-img" src="'+chatlist.heimg+'" />'
								+	'<div class="msg-content" style="width:'+dur*1+'%;min-width:15%;max-width:60%;" msg-type="'+data.type+'" msg-content="'+data.fileurl+'">'
								+		'<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>'
								+		'<span class="play-state disn">点击播放</span>'
								+		'<span class="cred fs24 fr" style="margin-top:-10px">·</span>'
								+	'</div>'
								+	temp3
								+'</div>';
							
						}else if(data.type=='image'){
							temp1.innerHTML='<div class="msg-item" id="'+id+'" >'
								+	'<img class="msg-user-img" src="'+chatlist.heimg+'" />'
								+	'<img class="msg-content-image" src="'+data.fileurl+'" style="max-width: 100px;" data-preview-src="" data-preview-group="1"/>'
								+	temp3
								+'</div>';
						}
					}
					return temp1;
				}
				mui('.mui-slider').on('tap','.mui-icon-download',function(){
					var url=ca.className('mui-slider')[0].querySelector('.mui-active').children[0].children[0].src;
							plus.gallery.save( url, function () {
								alert( "保存图片到相册成功" );
							} );
				})
				
				mui('#a').on('longtap','.msg-content',function(){
					// alert(this.innerHTML);
					// var odiv=document.getElementById('divid');
// 					alert(this.getBoundingClientRect().left);
// 					alert(this.getBoundingClientRect().top);
					// mui('#popover').popover('show');
					var top=this.getBoundingClientRect().top; 
					var left=this.getBoundingClientRect().left; 
					var right=this.getBoundingClientRect().right; 
// 					alert(left)
// 					alert(right)
					var clientWidth=ca.id('a').clientWidth;
					if(left<=150){
						ca.id('popover').style.left=(right-left)/2+'px';
					}else{
						ca.id('popover').style.left=left+'px';
					}
					ca.id('popover').style.top=top-35+'px';
					ca.id('popover').style.display='block';
					fuzhi(this.children[0].innerText);
				})
				ca.id('a').addEventListener('tap',function(){
					ca.id('popover').style.display='none';
				})
				function fuzhi(text){
					var te=text;
					ca.className('fuzhi')[0].addEventListener('tap',function(){
							setClipbordText(te);
							ca.id('popover').style.display='none';
					})
				}
				
				/**
				 * @description 设置剪贴板内容（复制）
				 */
				function setClipbordText(txt) {
						if(!window.plus) return;
						if(mui.os.android) {
						var Context = plus.android.importClass("android.content.Context");
						var main = plus.android.runtimeMainActivity();
						var clip = main.getSystemService(Context.CLIPBOARD_SERVICE);
						plus.android.invoke(clip,"setText",txt);
						} else {
						var UIPasteboard  = plus.ios.importClass("UIPasteboard");
						var generalPasteboard = UIPasteboard.generalPasteboard();
						generalPasteboard.setValueforPasteboardType(txt,"public.utf8-plain-text");
						}
				}
		
				
			})
		</script>
	</body>

</html>